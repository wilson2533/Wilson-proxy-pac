name: Update Proxy List Automatically

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROXY_PAC_TOKEN }}
        
    - name: Update proxies
      run: |
        echo "ðŸ“¥ Downloading proxy list..."
        curl -s "https://proxylist.geonode.com/api/proxy-list?limit=50&page=1&sort_by=lastChecked&sort_type=desc" -o proxies.json
        
        echo "ðŸ”„ Processing proxies..."
        jq -r '.data[]? | select(.ip? and .port?) | "\(.ip):\(.port)"' proxies.json > proxy_list.txt
        
        if [ ! -s proxy_list.txt ]; then
          echo "âš ï¸ Using default list"
          cat > proxy_list.txt << 'DEFAULT'
103.76.12.42:8181
118.69.111.51:80
103.83.232.122:80
190.109.18.113:8080
103.105.77.19:8080
DEFAULT
        fi
        
        head -25 proxy_list.txt > proxies_final.txt
        proxy_count=$(wc -l < proxies_final.txt)
        echo "âœ… Found $proxy_count proxies"
        
        js_proxies=""
        while IFS= read -r proxy; do
          if [ -n "$proxy" ]; then
            if [ -z "$js_proxies" ]; then
              js_proxies="\"$proxy\""
            else
              js_proxies="$js_proxies,\n        \"$proxy\""
            fi
          fi
        done < proxies_final.txt
        
        awk -v new_proxies="$js_proxies" '
          /var proxies = \[/ { in_array=1; print; next }
          in_array && /];/ { 
            print "        " new_proxies
            in_array=0
            next
          }
          in_array { next }
          { print }
        ' proxy.pac > proxy_updated.pac
        
        mv proxy_updated.pac proxy.pac
        rm -f proxies.json proxy_list.txt proxies_final.txt
        
        echo "ðŸŽ¯ Updated proxy.pac with $proxy_count proxies"
        
    - name: Commit and push changes
      run: |
        git config --local user.name "wilson2533"
        git config --local user.email "wilson2533@users.noreply.github.com"
        git add proxy.pac
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update proxy list"
        git push
