name: Update Proxy List Automatically

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:  # Ejecuci√≥n manual

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create and run update script
      run: |
        # Crear script de actualizaci√≥n usando curl y jq (ya instalado en Ubuntu)
        cat > update_proxies.sh << 'EOF'
        #!/bin/bash
        
        echo "üîç Obteniendo proxies de GeoNode API..."
        
        # Hacer la petici√≥n a la API y procesar con jq
        response=$(curl -s "https://proxylist.geonode.com/api/proxy-list?limit=50&page=1&sort_by=lastChecked&sort_type=desc")
        
        # Extraer proxies usando jq y formatear correctamente
        proxies=$(echo "$response" | jq -r '.data[] | select(.protocols[] | contains("http")) | select(.uptime | tonumber > 50) | "\(.ip):\(.port)"' | head -30)
        
        if [ -z "$proxies" ]; then
          echo "‚ùå No se pudieron obtener proxies"
          exit 1
        fi
        
        # Contar proxies
        proxy_count=$(echo "$proxies" | wc -l)
        echo "‚úÖ Encontrados $proxy_count proxies v√°lidos"
        
        # Leer el archivo PAC actual
        pac_content=$(cat proxy.pac)
        
        # Crear el array JavaScript de proxies
        js_proxies_array=""
        while IFS= read -r proxy; do
          if [ -n "$proxy" ]; then
            if [ -n "$js_proxies_array" ]; then
              js_proxies_array="$js_proxies_array,\n        \"$proxy\""
            else
              js_proxies_array="\"$proxy\""
            fi
          fi
        done <<< "$proxies"
        
        # Reemplazar la secci√≥n de proxies en el archivo PAC
        updated_pac=$(echo "$pac_content" | awk -v new_proxies="$js_proxies_array" '
          /var proxies = \[/ { printing=1; print; next }
          printing && /];/ { 
            print "        " new_proxies
            printing=0 
          }
          !printing { print }
        ')
        
        # Guardar el archivo actualizado
        echo "$updated_pac" > proxy.pac
        
        echo "üéØ Proxy PAC actualizado con $proxy_count proxies"
        echo "üìã Primeros 5 proxies:"
        echo "$proxies" | head -5
        EOF
        
        # Hacer el script ejecutable y ejecutarlo
        chmod +x update_proxies.sh
        ./update_proxies.sh
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add proxy.pac
        git diff --staged --quiet || git commit -m "ü§ñ Auto-update proxy list [$(date +%Y-%m-%d)]"
        git push
