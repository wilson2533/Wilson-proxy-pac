name: Update Proxy List

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROXY_PAC_TOKEN }}
        
    - name: Download proxy list
      run: |
        echo "ðŸ“¥ Downloading proxy list..."
        curl -s "https://proxylist.geonode.com/api/proxy-list?limit=50&page=1&sort_by=lastChecked&sort_type=desc" -o proxies.json
        
    - name: Process proxies
      run: |
        echo "ðŸ”„ Processing proxies..."
        jq -r '.data[]? | select(.ip? and .port?) | "\(.ip):\(.port)"' proxies.json > proxy_list.txt
        
        if [ ! -s proxy_list.txt ]; then
          echo "âš ï¸ Using default list"
          echo "103.76.12.42:8181" > proxy_list.txt
          echo "118.69.111.51:80" >> proxy_list.txt
          echo "103.83.232.122:80" >> proxy_list.txt
          echo "190.109.18.113:8080" >> proxy_list.txt
          echo "103.105.77.19:8080" >> proxy_list.txt
        fi
        
    - name: Update PAC file
      run: |
        head -20 proxy_list.txt > final.txt
        count=$(wc -l < final.txt)
        echo "âœ… Found $count proxies"
        
        # Build JavaScript array
        js_array=""
        while IFS= read -r proxy; do
          if [ -n "$proxy" ]; then
            if [ -z "$js_array" ]; then
              js_array="\"$proxy\""
            else
              js_array="$js_array,\"$proxy\""
            fi
          fi
        done < final.txt
        
        # Create new PAC content
        pac_content="function FindProxyForURL(url, host) {
    // PROXIES - AUTO UPDATED
    var proxies = [
        $js_array
    ];

    // DOMINIOS LOCALES - ACCESO DIRECTO
    if (isPlainHostName(host) || 
        shExpMatch(host, \"*.local\") ||
        shExpMatch(host, \"localhost\") ||
        isInNet(dnsResolve(host), \"10.0.0.0\", \"255.0.0.0\") ||
        isInNet(dnsResolve(host), \"172.16.0.0\", \"255.240.0.0\") ||
        isInNet(dnsResolve(host), \"192.168.0.0\", \"255.255.0.0\")) {
        return \"DIRECT\";
    }

    // SI NO HAY PROXIES, ACCESO DIRECTO
    if (proxies.length === 0) {
        return \"DIRECT\";
    }

    // PROXY ALEATORIO
    var randomProxy = proxies[Math.floor(Math.random() * proxies.length)];
    return \"PROXY \" + randomProxy + \"; DIRECT\";
}"
        
        echo "$pac_content" > proxy.pac
        echo "ðŸŽ¯ Updated proxy.pac with $count proxies"
        
    - name: Commit changes
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add proxy.pac
        git diff --cached --quiet || git commit -m "ðŸ¤– Update proxies"
        git push
