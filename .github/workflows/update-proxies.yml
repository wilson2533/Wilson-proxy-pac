name: Update Proxy List Automatically

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:  # EjecuciÃ³n manual

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create and run update script
      run: |
        # Crear script de actualizaciÃ³n mejorado
        cat > update_proxies.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸ” Obteniendo proxies de GeoNode API..."
        
        # Hacer la peticiÃ³n a la API
        response=$(curl -s "https://proxylist.geonode.com/api/proxy-list?limit=100&page=1&sort_by=lastChecked&sort_type=desc")
        
        # Verificar si la respuesta es vÃ¡lida
        if [ -z "$response" ] || [ "$response" = "null" ]; then
          echo "âŒ No se pudo obtener respuesta de la API"
          exit 1
        fi
        
        # Extraer proxies de forma mÃ¡s robusta
        proxies=$(echo "$response" | jq -r '
          .data[]? | 
          select(.ip != null and .port != null) |
          select(.protocols? != null and (.protocols | map(.? // "") | any(contains("http")))) |
          "\(.ip):\(.port)"' | head -40)
        
        if [ -z "$proxies" ]; then
          echo "âš ï¸ No se encontraron proxies vÃ¡lidos, usando lista por defecto"
          # Lista de respaldo
          proxies="103.76.12.42:8181
        118.69.111.51:80
        103.83.232.122:80
        190.109.18.113:8080
        103.105.77.19:8080"
        fi
        
        # Contar proxies
        proxy_count=$(echo "$proxies" | wc -l)
        echo "âœ… Encontrados $proxy_count proxies"
        
        # Leer el archivo PAC actual
        pac_content=$(cat proxy.pac)
        
        # Crear el array JavaScript de proxies
        js_proxies_array=""
        first=true
        while IFS= read -r proxy; do
          if [ -n "$proxy" ]; then
            if [ "$first" = true ]; then
              js_proxies_array="\"$proxy\""
              first=false
            else
              js_proxies_array="$js_proxies_array,\n        \"$proxy\""
            fi
          fi
        done <<< "$proxies"
        
        # Reemplazar la secciÃ³n de proxies en el archivo PAC usando sed
        # Primero crear un archivo temporal
        echo "$pac_content" | sed -n '
          /var proxies = \[/ {
            p
            :a
            n
            /];/! ba
            i \
        '"$js_proxies_array"'
          }
          /var proxies = \[/! p
        ' > proxy_temp.pac
        
        # Mover el archivo temporal al original
        mv proxy_temp.pac proxy.pac
        
        echo "ðŸŽ¯ Proxy PAC actualizado con $proxy_count proxies"
        echo "ðŸ“‹ Primeros 5 proxies:"
        echo "$proxies" | head -5
        EOF
        
        # Hacer el script ejecutable y ejecutarlo
        chmod +x update_proxies.sh
        ./update_proxies.sh
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add proxy.pac
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update proxy list [$(date +%Y-%m-%d)]"
        git push
