name: Update Proxy List Automatically

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:  # EjecuciÃ³n manual

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROXY_PAC_TOKEN }}
        
    - name: Update proxies
      run: |
        # Descargar datos de la API
        echo "ðŸ“¥ Descargando lista de proxies..."
        curl -s "https://proxylist.geonode.com/api/proxy-list?limit=50&page=1&sort_by=lastChecked&sort_type=desc" -o proxies.json
        
        # Procesar con jq
        echo "ðŸ”„ Procesando proxies..."
        jq -r '.data[]? | select(.ip? and .port?) | "\(.ip):\(.port)"' proxies.json > proxy_list.txt
        
        # Si no hay proxies, usar lista por defecto
        if [ ! -s proxy_list.txt ]; then
          echo "âš ï¸ Usando lista por defecto"
          cat > proxy_list.txt << DEFAULT
103.76.12.42:8181
118.69.111.51:80
103.83.232.122:80
190.109.18.113:8080
103.105.77.19:8080
DEFAULT
        fi
        
        # Tomar mÃ¡ximo 25 proxies
        head -25 proxy_list.txt > proxies_final.txt
        proxy_count=$(wc -l < proxies_final.txt)
        echo "âœ… Lista preparada con $proxy_count proxies"
        
        # Generar contenido JavaScript de proxies
        js_proxies=""
        while IFS= read -r proxy; do
          if [ -n "$proxy" ]; then
            if [ -z "$js_proxies" ]; then
              js_proxies="\"$proxy\""
            else
              js_proxies="$js_proxies,\n        \"$proxy\""
            fi
          fi
        done < proxies_final.txt
        
        # Actualizar el archivo PAC usando awk
        awk -v new_proxies="$js_proxies" '
          /var proxies = \[/ { in_array=1; print; next }
          in_array && /];/ { 
            print "        " new_proxies
            in_array=0
            next
          }
          in_array { next }
          { print }
        ' proxy.pac > proxy_updated.pac
        
        mv proxy_updated.pac proxy.pac
        
        echo "ðŸŽ¯ Actualizado proxy.pac con $proxy_count proxies"
        echo "ðŸ“‹ Ejemplos:"
        head -5 proxies_final.txt
        
        # Limpiar archivos temporales
        rm -f proxies.json proxy_list.txt proxies_final.txt
        
    - name: Commit and push changes
      run: |
        git config --local user.name "wilson2533"
        git config --local user.email "tu-email@usuairo.com"  # Reemplaza con tu email real
        git add proxy.pac
        git diff --staged --quiet && echo "No changes to commit" && exit 0
        git commit -m "ðŸ¤– Auto-update proxy list [$(date +%Y-%m-%d)]"
        git push
